<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Management - Island Breeze Hotels</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/admin-style.css" rel="stylesheet">
</head>
<body>
    <div class="d-flex">
        <nav class="admin-sidebar">
            <div class="sidebar-brand"><i class="fas fa-hotel"></i> Island Breeze</div>
            <ul class="sidebar-menu">
                <li class="menu-item"><a href="admin-dashboard.html" class="menu-link"><i class="fas fa-chart-line"></i> Dashboard</a></li>
                <li class="menu-item"><a href="admin-guests.html" class="menu-link"><i class="fas fa-users"></i> Guests</a></li>
                <li class="menu-item"><a href="admin-rooms.html" class="menu-link"><i class="fas fa-door-open"></i> Rooms</a></li>
                <li class="menu-item"><a href="admin-bookings.html" class="menu-link"><i class="fas fa-calendar-check"></i> Bookings</a></li>
                <li class="menu-item"><a href="admin-payments.html" class="menu-link active"><i class="fas fa-credit-card"></i> Payments</a></li>
                <li class="menu-item mt-auto"><a href="#" class="menu-link" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        </nav>

        <main class="admin-main">
            <div class="page-header">
                <h1 class="page-title"><i class="fas fa-credit-card me-3"></i>Payment Management</h1>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPaymentModal">
                    <i class="fas fa-plus me-2"></i>Add Payment
                </button>
            </div>

            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="stat-card">
                        <div class="stat-value text-success" id="totalRevenue">$0</div>
                        <div class="stat-label">Total Revenue</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card">
                        <div class="stat-value text-warning" id="pendingPayments">0</div>
                        <div class="stat-label">Pending Payments</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card">
                        <div class="stat-value text-info" id="completedPayments">0</div>
                        <div class="stat-label">Completed Payments</div>
                    </div>
                </div>
            </div>

            <div class="content-card">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Payment ID</th>
                                <th>Guest ID</th>
                                <th>Booking ID</th>
                                <th>Amount</th>
                                <th>Method</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="paymentsTableBody">
                            <tr>
                                <td colspan="8" class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- View Payment Modal -->
    <div class="modal fade" id="viewPaymentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-eye me-2"></i>Payment Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Payment ID:</label>
                            <p id="viewPaymentId" class="form-control-plaintext">-</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Status:</label>
                            <p id="viewPaymentStatus" class="form-control-plaintext">-</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Guest ID:</label>
                            <p id="viewPaymentGuestId" class="form-control-plaintext">-</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Booking ID:</label>
                            <p id="viewPaymentBookingId" class="form-control-plaintext">-</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Amount:</label>
                            <p id="viewPaymentAmount" class="form-control-plaintext">-</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Payment Method:</label>
                            <p id="viewPaymentMethod" class="form-control-plaintext">-</p>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label class="form-label fw-bold">Payment Date:</label>
                            <p id="viewPaymentDate" class="form-control-plaintext">-</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Payment Modal -->
    <div class="modal fade" id="addPaymentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-plus me-2"></i>Add New Payment</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addPaymentForm">
                        <div class="mb-3">
                            <label for="paymentGuestId" class="form-label">Guest ID</label>
                            <input type="text" class="form-control" id="paymentGuestId" required>
                        </div>
                        <div class="mb-3">
                            <label for="paymentBookingId" class="form-label">Booking ID</label>
                            <input type="text" class="form-control" id="paymentBookingId" required>
                        </div>
                        <div class="mb-3">
                            <label for="paymentAmount" class="form-label">Amount ($)</label>
                            <input type="number" step="0.01" class="form-control" id="paymentAmount" required>
                        </div>
                        <div class="mb-3">
                            <label for="paymentMethod" class="form-label">Payment Method</label>
                            <select class="form-select" id="paymentMethod" required>
                                <option value="">Select Method</option>
                                <option value="Credit Card">Credit Card</option>
                                <option value="Debit Card">Debit Card</option>
                                <option value="Cash">Cash</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                                <option value="PayPal">PayPal</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="paymentStatus" class="form-label">Status</label>
                            <select class="form-select" id="paymentStatus" required>
                                <option value="Pending">Pending</option>
                                <option value="Completed">Completed</option>
                                <option value="Failed">Failed</option>
                                <option value="Refunded">Refunded</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addPayment()">
                        <i class="fas fa-save me-2"></i>Save Payment
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/admin-common.js"></script>
    <script>
        async function fetchPayments() {
            try {
                const response = await fetch('/api/payments');
                if (response.ok) {
                    const payments = await response.json();
                    displayPayments(payments);
                    updateStats(payments);
                } else {
                    throw new Error('Failed to fetch payments');
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('paymentsTableBody').innerHTML = 
                    '<tr><td colspan="8" class="text-center text-danger">Failed to load payments</td></tr>';
            }
        }

        function displayPayments(payments) {
            const tbody = document.getElementById('paymentsTableBody');
            if (payments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No payments found</td></tr>';
                return;
            }

            tbody.innerHTML = payments.map(payment => `
                <tr>
                    <td><strong>#${payment.paymentId || 'N/A'}</strong></td>
                    <td>${payment.guestId || 'N/A'}</td>
                    <td>${payment.bookingId || 'N/A'}</td>
                    <td><strong>$${payment.amount || 0}</strong></td>
                    <td>${payment.paymentMethod || 'N/A'}</td>
                    <td><span class="badge bg-${getStatusColor(payment.status)}">${payment.status || 'Unknown'}</span></td>
                    <td>${formatDate(payment.paymentDate)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary btn-action" onclick='viewPayment(${JSON.stringify(payment)})'>
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger btn-action" onclick="deletePayment('${payment.paymentId}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function updateStats(payments) {
            const totalRevenue = payments
                .filter(p => p.status === 'Completed')
                .reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
            
            const pending = payments.filter(p => p.status === 'Pending').length;
            const completed = payments.filter(p => p.status === 'Completed').length;

            document.getElementById('totalRevenue').textContent = `$${totalRevenue.toLocaleString()}`;
            document.getElementById('pendingPayments').textContent = pending;
            document.getElementById('completedPayments').textContent = completed;
        }

        function getStatusColor(status) {
            const colors = {
                'Pending': 'warning',
                'Completed': 'success',
                'Failed': 'danger',
                'Refunded': 'info'
            };
            return colors[status] || 'secondary';
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString();
        }

        async function addPayment() {
            const payment = {
                guestId: document.getElementById('paymentGuestId').value,
                bookingId: document.getElementById('paymentBookingId').value,
                amount: parseFloat(document.getElementById('paymentAmount').value),
                paymentMethod: document.getElementById('paymentMethod').value,
                status: document.getElementById('paymentStatus').value,
                paymentDate: new Date().toISOString()
            };

            try {
                const response = await fetch('/api/payments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    },
                    body: JSON.stringify(payment)
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('addPaymentModal')).hide();
                    document.getElementById('addPaymentForm').reset();
                    fetchPayments();
                    alert('Payment added successfully!');
                } else {
                    alert('Failed to add payment');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred');
            }
        }

        function viewPayment(payment) {
            // Populate modal with payment details
            document.getElementById('viewPaymentId').textContent = payment.paymentId || 'N/A';
            document.getElementById('viewPaymentStatus').innerHTML = `<span class="badge bg-${getStatusColor(payment.status)}">${payment.status || 'Unknown'}</span>`;
            document.getElementById('viewPaymentGuestId').textContent = payment.guestId || 'N/A';
            document.getElementById('viewPaymentBookingId').textContent = payment.bookingId || 'N/A';
            document.getElementById('viewPaymentAmount').textContent = '$' + (payment.amount || 0);
            document.getElementById('viewPaymentMethod').textContent = payment.paymentMethod || 'N/A';
            document.getElementById('viewPaymentDate').textContent = formatDate(payment.paymentDate);
            
            // Show modal
            new bootstrap.Modal(document.getElementById('viewPaymentModal')).show();
        }

        async function deletePayment(paymentId) {
            if (!confirm('Are you sure you want to delete this payment?')) {
                return;
            }

            try {
                const response = await fetch(`/api/payments/${paymentId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    }
                });

                if (response.ok) {
                    fetchPayments();
                    alert('Payment deleted successfully!');
                } else {
                    alert('Failed to delete payment');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred');
            }
        }

        fetchPayments();
    </script>
</body>
</html>
