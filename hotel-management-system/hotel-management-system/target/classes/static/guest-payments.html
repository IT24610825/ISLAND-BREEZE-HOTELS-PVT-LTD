<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Payments - Island Breeze Hotels</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --light-bg: #f5f6fa;
            --card-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--light-bg);
            color: #333;
        }
        
        /* Navigation */
        .navbar {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
        }
        
        /* Main Content */
        .container {
            padding-top: 2rem;
            padding-bottom: 4rem;
        }
        
        .page-header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            margin-bottom: 30px;
        }
        
        .page-header h1 {
            color: var(--primary-color);
            font-weight: 700;
        }
        
        /* Payment Summary */
        .payment-summary {
            background: linear-gradient(135deg, var(--secondary-color) 0%, #2980b9 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: var(--card-shadow);
        }
        
        .payment-summary h2 {
            font-weight: 700;
            font-size: 2rem;
            margin-bottom: 0.25rem;
        }
        
        .payment-summary p {
            opacity: 0.9;
            margin-bottom: 0;
        }
        
        /* Cards */
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background-color: white;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            font-weight: 600;
            padding: 1.25rem 1.5rem;
            border-radius: 15px 15px 0 0 !important;
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        /* Payment Items */
        .payment-item {
            border-left: 4px solid var(--secondary-color);
            padding: 20px;
            margin-bottom: 15px;
            background: white;
            border-radius: 10px;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .payment-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        
        .payment-details {
            flex: 1;
        }
        
        .payment-amount {
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .payment-date {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        /* Badges */
        .badge {
            padding: 8px 15px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-pending {
            background-color: #f39c12;
        }
        
        .badge-paid {
            background-color: var(--success-color);
        }
        
        .badge-failed {
            background-color: var(--danger-color);
        }
        
        /* Form Elements */
        .form-label {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #495057;
        }
        
        .form-control, .form-select {
            padding: 0.75rem 1rem;
            border: 1px solid #e1e5eb;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
        }
        
        /* Buttons */
        .btn {
            padding: 0.65rem 1.5rem;
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
            border-color: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn-outline-primary {
            color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .btn-outline-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        /* Tabs */
        .nav-tabs {
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 1.5rem;
        }
        
        .nav-tabs .nav-link {
            border: none;
            color: #6c757d;
            font-weight: 500;
            padding: 0.75rem 1.5rem;
            margin-right: 0.5rem;
            border-radius: 8px 8px 0 0;
            transition: all 0.3s ease;
        }
        
        .nav-tabs .nav-link.active {
            color: var(--secondary-color);
            background-color: rgba(52, 152, 219, 0.1);
            border-bottom: 3px solid var(--secondary-color);
        }
        
        /* Card Elements */
        .card-item {
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        
        .card-item:hover {
            border-color: var(--secondary-color);
            transform: translateY(-2px);
        }
        
        .card-item.selected {
            border-color: var(--secondary-color);
            background-color: #f8f9ff;
        }
        
        .card-item.default {
            border-color: var(--success-color);
            background-color: #f8fff8;
        }
        
        .card-number {
            font-family: 'Courier New', monospace;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-color);
            letter-spacing: 0.5px;
        }
        
        .card-expiry {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .card-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* Utility Classes */
        .hidden {
            display: none !important;
        }
        
        .form-section {
            display: none;
        }
        
        .form-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .page-header {
                padding: 20px;
            }
            
            .payment-summary {
                padding: 20px;
            }
            
            .payment-item {
                flex-direction: column;
                text-align: left;
                align-items: flex-start;
            }
            
            .payment-amount {
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#">
                <i class="fas fa-hotel me-2"></i>Island Breeze Hotels
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="guest-dashboard.html">
                            <i class="fas fa-home me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="guest-payments.html">
                            <i class="fas fa-credit-card me-1"></i>Payments
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="guest-cards.html">
                            <i class="fas fa-wallet me-1"></i>My Cards
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="guest-reviews.html">
                            <i class="fas fa-star me-1"></i>Reviews
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="guest-contact.html">
                            <i class="fas fa-phone-alt me-1"></i>Contact Us
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="logoutBtn">
                            <i class="fas fa-sign-out-alt me-1"></i>Logout
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <div class="page-header">
            <h1><i class="fas fa-credit-card me-3"></i>My Payments & Cards</h1>
            <p class="text-muted mb-0">Manage your payment history and saved cards</p>
        </div>

        <!-- Payment Summary -->
        <div class="row mb-4">
            <div class="col-md-4 mb-3">
                <div class="payment-summary text-center">
                    <h2 id="totalPaid">$0</h2>
                    <p>Total Paid</p>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="payment-summary text-center" style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);">
                    <h2 id="pendingAmount">$0</h2>
                    <p>Pending</p>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="payment-summary text-center" style="background: linear-gradient(135deg, #27ae60 0%, #219653 100%);">
                    <h2 id="paymentCount">0</h2>
                    <p>Transactions</p>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs" id="paymentTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="payments-tab" data-bs-toggle="tab" data-bs-target="#payments" type="button" role="tab">
                    <i class="fas fa-history me-2"></i>Payment History
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="make-payment-tab" data-bs-toggle="tab" data-bs-target="#make-payment" type="button" role="tab">
                    <i class="fas fa-plus-circle me-2"></i>Make a Payment
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="cards-tab" data-bs-toggle="tab" data-bs-target="#cards" type="button" role="tab">
                    <i class="far fa-credit-card me-2"></i>My Cards
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="paymentTabContent">
            <!-- Payment History Tab -->
            <div class="tab-pane fade show active" id="payments" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="card-title mb-0">Recent Transactions</h5>
                            <button class="btn btn-sm btn-outline-primary" onclick="window.print()">
                                <i class="fas fa-print me-1"></i> Print Statement
                            </button>
                        </div>
                        <div id="paymentsList">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading payment history...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Make Payment Tab -->
            <div class="tab-pane fade" id="make-payment" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h3 class="card-title mb-4"><i class="fas fa-plus-circle me-2"></i>Make a Payment</h3>
                        <form id="paymentForm" class="needs-validation" novalidate>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="bookingId" class="form-label">Booking ID</label>
                                    <input type="text" class="form-control" id="bookingId" required>
                                    <div class="invalid-feedback">Please enter a booking ID</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="amount" class="form-label">Amount ($)</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="amount" min="0" step="0.01" required>
                                        <div class="invalid-feedback">Please enter a valid amount</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label class="form-label">Payment Method</label>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="paymentMethod" id="newCardRadio" value="NEW_CARD" checked>
                                    <label class="form-check-label" for="newCardRadio">
                                        New Credit/Debit Card
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="paymentMethod" id="savedCardRadio" value="SAVED_CARD">
                                    <label class="form-check-label" for="savedCardRadio">
                                        Use Saved Card
                                    </label>
                                </div>
                            </div>

                            <!-- New Card Form -->
                            <div id="newCardSection" class="form-section active">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="newCardNumber" class="form-label">Card Number</label>
                                        <input type="text" class="form-control" id="newCardNumber" 
                                               placeholder="1234 5678 9012 3456" required
                                               pattern="\d{4}\s?\d{4}\s?\d{4}\s?\d{4}"
                                               oninput="formatCardNumber(this)">
                                        <div class="invalid-feedback">Please enter a valid 16-digit card number</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="cardHolderName" class="form-label">Cardholder Name</label>
                                        <input type="text" class="form-control" id="cardHolderName" required>
                                        <div class="invalid-feedback">Please enter the cardholder name</div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="expiryDate" class="form-label">Expiry Date</label>
                                        <input type="text" class="form-control" id="expiryDate" 
                                               placeholder="MM/YY" required
                                               pattern="(0[1-9]|1[0-2])\/?([0-9]{2})"
                                               oninput="formatExpiryDate(this)">
                                        <div class="invalid-feedback">Please enter a valid expiry date (MM/YY)</div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="cvv" class="form-label">CVV</label>
                                        <input type="text" class="form-control" id="cvv" 
                                               placeholder="123" required
                                               pattern="\d{3,4}"
                                               maxlength="4"
                                               onkeypress="return isNumberKey(event)">
                                        <div class="invalid-feedback">Please enter a valid CVV</div>
                                    </div>
                                    <div class="col-md-4 mb-3 d-flex align-items-end">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="saveCard">
                                            <label class="form-check-label" for="saveCard">
                                                Save card for future payments
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Saved Cards -->
                            <div id="savedCardsSection" class="form-section">
                                <div id="savedCardsList" class="mb-3">
                                    <div class="text-center py-3">
                                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2">Loading saved cards...</p>
                                    </div>
                                </div>
                                <div class="text-end mb-3">
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="showAddCardModal()">
                                        <i class="fas fa-plus me-1"></i> Add New Card
                                    </button>
                                </div>
                            </div>

                            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                                <button type="button" class="btn btn-light me-md-2" onclick="resetPaymentForm()">Cancel</button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-lock me-2"></i>Make Secure Payment
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- My Cards Tab -->
            <div class="tab-pane fade" id="cards" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h3 class="card-title mb-0"><i class="far fa-credit-card me-2"></i>My Saved Cards</h3>
                            <button class="btn btn-primary btn-sm" onclick="showAddCardModal()">
                                <i class="fas fa-plus me-1"></i> Add New Card
                            </button>
                        </div>
                        
                        <div id="cardsList">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading your saved cards...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Card Modal -->
    <div class="modal fade" id="cardModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cardModalTitle">Add New Card</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="cardForm" class="needs-validation" novalidate>
                        <input type="hidden" id="editCardId">
                        <div class="mb-3">
                            <label for="modalCardNumber" class="form-label">Card Number</label>
                            <input type="text" class="form-control" id="modalCardNumber" 
                                   placeholder="1234 5678 9012 3456" required
                                   pattern="\d{4}\s?\d{4}\s?\d{4}\s?\d{4}"
                                   oninput="formatCardNumber(this)">
                            <div class="invalid-feedback">Please enter a valid 16-digit card number</div>
                        </div>
                        <div class="mb-3">
                            <label for="modalCardName" class="form-label">Cardholder Name</label>
                            <input type="text" class="form-control" id="modalCardName" required>
                            <div class="invalid-feedback">Please enter the cardholder name</div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="modalExpiryDate" class="form-label">Expiry Date</label>
                                <input type="text" class="form-control" id="modalExpiryDate" 
                                       placeholder="MM/YY" required
                                       pattern="(0[1-9]|1[0-2])\/?([0-9]{2})"
                                       oninput="formatExpiryDate(this)">
                                <div class="invalid-feedback">Please enter a valid expiry date (MM/YY)</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="modalCvv" class="form-label">CVV</label>
                                <input type="text" class="form-control" id="modalCvv" 
                                       placeholder="123" required
                                       pattern="\d{3,4}"
                                       maxlength="4"
                                       onkeypress="return isNumberKey(event)">
                                <div class="invalid-feedback">Please enter a valid CVV</div>
                            </div>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="setAsDefault">
                            <label class="form-check-label" for="setAsDefault">
                                Set as default payment method
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveCardBtn" onclick="saveCard()">Save Card</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Toast -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-success text-white">
                <strong class="me-auto">Success</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="successMessage">
                Operation completed successfully!
            </div>
        </div>
    </div>

    <!-- Error Toast -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="errorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-danger text-white">
                <strong class="me-auto">Error</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="errorMessage">
                An error occurred. Please try again.
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let isSubmitting = false;
        const guestInfo = JSON.parse(localStorage.getItem('guestInfo') || '{}');
        
        // Check if user is logged in
        function checkLoggedIn() {
            if (!guestInfo || !guestInfo.id) {
                window.location.href = 'index.html';
                return false;
            }
            return true;
        }
        
        // Only proceed if user is logged in
        if (!checkLoggedIn()) {
            window.location.href = 'index.html';
        }

        // Initialize tooltips
        document.addEventListener('DOMContentLoaded', function() {
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function(tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            // Initialize forms validation
            const forms = document.querySelectorAll('.needs-validation');
            Array.from(forms).forEach(form => {
                form.addEventListener('submit', event => {
                    if (!form.checkValidity()) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                }, false);
            });
            
            // Initialize payment method toggle
            const paymentMethodRadios = document.querySelectorAll('input[name="paymentMethod"]');
            paymentMethodRadios.forEach(radio => {
                radio.addEventListener('change', togglePaymentFields);
            });
            
            // Load initial data
            fetchPayments();
            fetchCards();
            loadPendingPayments();
            // Periodic refresh for payment summary and pending amounts
            let paymentsRefreshTimer = setInterval(() => {
                if (!document.hidden) {
                    fetchPayments();
                    loadPendingPayments();
                }
            }, 15000);
            // Refresh when tab becomes visible
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    fetchPayments();
                    loadPendingPayments();
                }
            });
            // Cleanup on unload
            window.addEventListener('beforeunload', () => {
                if (paymentsRefreshTimer) clearInterval(paymentsRefreshTimer);
            });
            
            // Logout button
            document.getElementById('logoutBtn')?.addEventListener('click', function(e) {
                e.preventDefault();
                localStorage.removeItem('guestToken');
                localStorage.removeItem('guestInfo');
                window.location.href = 'index.html';
            });
            
            // Tab change event
            const tabEl = document.querySelector('button[data-bs-toggle="tab"]');
            if (tabEl) {
                tabEl.addEventListener('shown.bs.tab', function (event) {
                    if (event.target.id === 'cards-tab') {
                        fetchCards();
                    } else if (event.target.id === 'payments-tab') {
                        fetchPayments();
                    }
                });
            }
        });

        // Format card number with spaces
        function formatCardNumber(input) {
            let value = input.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
            let formatted = '';
            
            for (let i = 0; i < value.length; i++) {
                if (i > 0 && i % 4 === 0) {
                    formatted += ' ';
                }
                formatted += value[i];
            }
            
            input.value = formatted;
        }
        
        // Format expiry date as MM/YY
        function formatExpiryDate(input) {
            let value = input.value.replace(/\D/g, '');
            
            if (value.length > 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            
            input.value = value;
        }
        
        // Allow only numbers
        function isNumberKey(evt) {
            const charCode = (evt.which) ? evt.which : evt.keyCode;
            if (charCode > 31 && (charCode < 48 || charCode > 57)) {
                evt.preventDefault();
                return false;
            }
            return true;
        }
        
        // Toggle payment fields based on selected method
        function togglePaymentFields() {
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            const newCardSection = document.getElementById('newCardSection');
            const savedCardsSection = document.getElementById('savedCardsSection');
            
            if (paymentMethod === 'NEW_CARD') {
                newCardSection.classList.add('active');
                savedCardsSection.classList.remove('active');
            } else if (paymentMethod === 'SAVED_CARD') {
                newCardSection.classList.remove('active');
                savedCardsSection.classList.add('active');
                loadSavedCardsForPayment();
            }
        }
        
        // Fetch payment history
        async function fetchPayments() {
            try {
                const response = await fetch(`/api/payments/guest/${guestInfo.id}`);
                if (response.ok) {
                    const payments = await response.json();
                    displayPayments(payments);
                    updateSummary(payments);
                } else {
                    throw new Error('Failed to fetch payments');
                }
            } catch (error) {
                console.error('Error fetching payments:', error);
                showError('Failed to load payment history. Please try again later.');
            }
        }
        
        // Fetch saved cards
        async function fetchCards() {
            try {
                const response = await fetch(`/api/cards/user/${guestInfo.id}`);
                if (response.ok) {
                    const cards = await response.json();
                    displayCards(cards);
                } else {
                    throw new Error('Failed to fetch cards');
                }
            } catch (error) {
                console.error('Error fetching cards:', error);
                showError('Failed to load saved cards. Please try again later.');
            }
        }
        
        // Display payments in the table
        function displayPayments(payments) {
            const paymentsList = document.getElementById('paymentsList');
            
            if (!payments || payments.length === 0) {
                paymentsList.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-credit-card fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No payment history found</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Transaction ID</th>
                                <th>Booking ID</th>
                                <th>Description</th>
                                <th class="text-end">Amount</th>
                                <th class="text-center">Status</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            payments.forEach(payment => {
                const paymentDate = new Date(payment.paymentDate || new Date()).toLocaleDateString();
                const amount = parseFloat(payment.amount || 0).toFixed(2);
                const status = payment.status || 'PENDING';
                const statusColor = getStatusColor(status);
                
                html += `
                    <tr>
                        <td>${paymentDate}</td>
                        <td>${payment.paymentId || 'N/A'}</td>
                        <td>${payment.bookingId || 'N/A'}</td>
                        <td>${payment.description || 'Room Booking Payment'}</td>
                        <td class="text-end">$${amount}</td>
                        <td class="text-center">
                            <span class="badge ${statusColor}">${status}</span>
                        </td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-primary me-1" 
                                    onclick="downloadReceipt('${payment.paymentId}')"
                                    data-bs-toggle="tooltip" 
                                    title="Download Receipt">
                                <i class="fas fa-download"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            paymentsList.innerHTML = html;
            
            // Re-initialize tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function(tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }
        
        // Display saved cards
        function displayCards(cards) {
            const cardsList = document.getElementById('cardsList');
            
            if (!cards || cards.length === 0) {
                cardsList.innerHTML = `
                    <div class="text-center py-5">
                        <i class="far fa-credit-card fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No saved cards found</p>
                        <button class="btn btn-primary mt-2" onclick="showAddCardModal()">
                            <i class="fas fa-plus me-1"></i> Add New Card
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="row">';
            
            cards.forEach(card => {
                const lastFour = card.cardNumber ? card.cardNumber.slice(-4) : '••••';
                const cardType = getCardType(card.cardNumber || '');
                const isDefault = card.isDefault ? 'default' : '';
                const cardClass = `card-item ${isDefault}`;
                
                html += `
                    <div class="col-md-6 mb-3">
                        <div class="${cardClass}" id="card-${card.cardId}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="${getCardIconClass(cardType)} me-2" style="font-size: 1.25rem;"></i>
                                        <span class="fw-bold">${cardType}</span>
                                        ${card.isDefault ? '<span class="badge bg-success ms-2">Default</span>' : ''}
                                    </div>
                                    <div class="card-number">•••• •••• •••• ${lastFour}</div>
                                    <div class="text-muted small mt-1">Expires ${card.expiryDate || '••/••'}</div>
                                    <div class="text-muted small">${card.cardHolderName || 'Cardholder Name'}</div>
                                </div>
                            </div>
                            <div class="card-actions">
                                <button class="btn btn-sm btn-outline-primary" onclick="editCard('${card.cardId}')">
                                    <i class="fas fa-edit me-1"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" 
                                        onclick="setDefaultCard('${card.cardId}')"
                                        ${card.isDefault ? 'disabled' : ''}>
                                    <i class="fas fa-star me-1"></i> Set as Default
                                </button>
                                <button class="btn btn-sm btn-outline-danger" 
                                        onclick="deleteCard('${card.cardId}')">
                                    <i class="fas fa-trash-alt me-1"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            cardsList.innerHTML = html;
        }
        
        // Load saved cards for payment
        async function loadSavedCardsForPayment() {
            try {
                const response = await fetch(`/api/cards/user/${guestInfo.id}`);
                if (response.ok) {
                    const cards = await response.json();
                    const savedCardsList = document.getElementById('savedCardsList');
                    
                    if (!cards || cards.length === 0) {
                        savedCardsList.innerHTML = `
                            <div class="alert alert-info">
                                No saved cards found. Please add a new card.
                            </div>
                        `;
                        return;
                    }
                    
                    let html = '<div class="list-group">';
                    
                    cards.forEach((card, index) => {
                        const lastFour = card.cardNumber ? card.cardNumber.slice(-4) : '••••';
                        const cardType = getCardType(card.cardNumber || '');
                        const isDefault = card.isDefault ? 'border-primary' : '';
                        
                        html += `
                            <div class="list-group-item list-group-item-action ${isDefault}">
                                <div class="form-check">
                                    <input class="form-check-input" 
                                           type="radio" 
                                           name="savedCard" 
                                           id="savedCard${index}" 
                                           value="${card.cardId}"
                                           ${card.isDefault ? 'checked' : ''}
                                           onchange="selectCard('${card.cardId}')">
                                    <label class="form-check-label d-flex align-items-center" for="savedCard${index}">
                                        <i class="${getCardIconClass(cardType)} me-2"></i>
                                        <span>•••• •••• •••• ${lastFour} (${card.expiryDate || '••/••'})</span>
                                        ${card.isDefault ? '<span class="badge bg-primary ms-2">Default</span>' : ''}
                                    </label>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    savedCardsList.innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading saved cards:', error);
                showError('Failed to load saved cards. Please try again.');
            }
        }
        
        // Select a saved card for payment
        function selectCard(cardId) {
            // Remove selected class from all cards
            document.querySelectorAll('.list-group-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add selected class to the clicked card
            const selectedCard = document.querySelector(`input[value="${cardId}"]`).closest('.list-group-item');
            if (selectedCard) {
                selectedCard.classList.add('active');
            }
        }
        
        // Show add card modal
        function showAddCardModal() {
            document.getElementById('cardModalTitle').textContent = 'Add New Card';
            document.getElementById('cardForm').reset();
            document.getElementById('editCardId').value = '';
            document.getElementById('setAsDefault').checked = false;
            
            const modal = new bootstrap.Modal(document.getElementById('cardModal'));
            modal.show();
        }
        
        // Edit card
        function editCard(cardId) {
            fetch(`/api/cards/${cardId}/user/${guestInfo.id}`)
                .then(response => response.json())
                .then(card => {
                    document.getElementById('cardModalTitle').textContent = 'Edit Card';
                    document.getElementById('editCardId').value = card.id;
                    document.getElementById('modalCardNumber').value = card.cardNumber || '';
                    document.getElementById('modalCardName').value = card.cardHolderName || '';
                    document.getElementById('modalExpiryDate').value = card.expiryDate || '';
                    document.getElementById('modalCvv').value = '';
                    document.getElementById('setAsDefault').checked = card.isDefault || false;
                    
                    const modal = new bootstrap.Modal(document.getElementById('cardModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error('Error fetching card details:', error);
                    showError('Failed to load card details. Please try again.');
                });
        }
        
        // Save card (add or update)
        async function saveCard() {
            const cardId = document.getElementById('editCardId').value;
            const cardNumber = document.getElementById('modalCardNumber').value.replace(/\s+/g, '');
            const cardholderName = document.getElementById('modalCardName').value;
            const expiryDate = document.getElementById('modalExpiryDate').value;
            const cvv = document.getElementById('modalCvv').value;
            const isDefault = document.getElementById('setAsDefault').checked;
            
            if (!cardNumber || !cardholderName || !expiryDate || !cvv) {
                showError('Please fill in all required fields');
                return;
            }
            
            // Backend expects exactly 12 digits; trim to first 12
            const cardNumber12 = cardNumber.replace(/\D/g, '').slice(0, 12);
            if (cardNumber12.length !== 12) {
                showError('Please enter a valid card number (12+ digits)');
                return;
            }
            
            // Map to backend DTOs
            const createPayload = {
                cardNumber: cardNumber12,
                cardHolderName: cardholderName,
                cvv: cvv,
                expiryDate: expiryDate,
                cardType: 'CREDIT',
                isDefault: isDefault
            };
            const updatePayload = {
                cardHolderName: cardholderName,
                cvv: cvv,
                expiryDate: expiryDate,
                cardType: 'CREDIT',
                isDefault: isDefault
            };
            
            try {
                const url = cardId ? `/api/cards/${cardId}/user/${guestInfo.id}` : `/api/cards/user/${guestInfo.id}`;
                const method = cardId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(cardId ? updatePayload : createPayload)
                });
                
                if (response.ok) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('cardModal'));
                    modal.hide();
                    
                    showSuccess(cardId ? 'Card updated successfully' : 'Card added successfully');
                    
                    // Refresh cards list
                    fetchCards();
                    loadSavedCardsForPayment();
                } else {
                    const error = await response.text();
                    throw new Error(error || 'Failed to save card');
                }
            } catch (error) {
                console.error('Error saving card:', error);
                showError('Failed to save card. Please try again.');
            }
        }
        
        // Delete card
        function deleteCard(cardId) {
            if (!confirm('Are you sure you want to delete this card?')) {
                return;
            }
            
            fetch(`/api/cards/${cardId}/user/${guestInfo.id}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (response.ok) {
                    showSuccess('Card deleted successfully');
                    fetchCards();
                    loadSavedCardsForPayment();
                } else {
                    throw new Error('Failed to delete card');
                }
            })
            .catch(error => {
                console.error('Error deleting card:', error);
                showError('Failed to delete card. Please try again.');
            });
        }
        
        // Set default card
        function setDefaultCard(cardId) {
            fetch(`/api/cards/${cardId}/user/${guestInfo.id}/default`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (response.ok) {
                    showSuccess('Default card updated successfully');
                    fetchCards();
                    loadSavedCardsForPayment();
                } else {
                    throw new Error('Failed to set default card');
                }
            })
            .catch(error => {
                console.error('Error setting default card:', error);
                showError('Failed to set default card. Please try again.');
            });
        }
        
        // Process payment form submission
        document.getElementById('paymentForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (isSubmitting) {
                return;
            }
            
            const form = e.target;
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return;
            }
            
            const submitButton = form.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.innerHTML;
            
            isSubmitting = true;
            
            try {
                const bookingIdInput = document.getElementById('bookingId');
                const bookingId = (bookingIdInput.value || '').trim();
                if (!bookingId) {
                    showError('Please enter a valid Booking ID');
                    bookingIdInput.classList.add('is-invalid');
                    bookingIdInput.focus();
                    return;
                } else {
                    bookingIdInput.classList.remove('is-invalid');
                }
                // Only now disable the button and show spinner
                submitButton.disabled = true;
                submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> Processing...';
                const amount = parseFloat(document.getElementById('amount').value);
                const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
                
                let paymentData = {
                    bookingId: bookingId,
                    guestId: guestInfo.id,
                    amount: amount,
                    paymentMethod: paymentMethod,
                    status: 'PENDING'
                };
                
                // Add card details if paying with a new card
                if (paymentMethod === 'NEW_CARD') {
                    const cardNumber = document.getElementById('newCardNumber').value.replace(/\s+/g, '');
                    const cardholderName = document.getElementById('cardHolderName').value;
                    const expiryDate = document.getElementById('expiryDate').value;
                    const cvv = document.getElementById('cvv').value;
                    const saveCard = document.getElementById('saveCard').checked;
                    
                    paymentData.cardDetails = {
                        cardNumber: cardNumber,
                        cardholderName: cardholderName,
                        expiryDate: expiryDate,
                        cvv: cvv
                    };
                    
                    if (saveCard) {
                        paymentData.saveCard = true;
                        paymentData.isDefault = false; // Don't set as default automatically
                    }
                }
                // Add card ID if paying with a saved card
                else if (paymentMethod === 'SAVED_CARD') {
                    const selectedCard = document.querySelector('input[name="savedCard"]:checked');
                    if (!selectedCard) {
                        throw new Error('Please select a saved card');
                    }
                    paymentData.cardId = selectedCard.value;
                }
                
                // Process payment via booking-based endpoint
                const response = await fetch(`/api/payments/booking/${encodeURIComponent(bookingId)}?guestId=${encodeURIComponent(guestInfo.id)}&paymentMethod=CARD`, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error || 'Payment failed');
                }
                
                const result = await response.json();
                
                // Show success message
                showSuccess('Payment processed successfully!');
                
                // Reset form
                form.reset();
                form.classList.remove('was-validated');
                
                // Refresh data
                await Promise.all([
                    fetchPayments(),
                    fetchCards(),
                    loadPendingPayments()
                ]);
                
                // Switch to payments tab
                const paymentsTab = document.getElementById('payments-tab');
                if (paymentsTab) {
                    const tab = new bootstrap.Tab(paymentsTab);
                    tab.show();
                }
                
            } catch (error) {
                console.error('Payment error:', error);
                showError(error.message || 'An error occurred while processing your payment. Please try again.');
            } finally {
                isSubmitting = false;
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
            }
        });
        
        // Reset payment form
        function resetPaymentForm() {
            const form = document.getElementById('paymentForm');
            form.reset();
            form.classList.remove('was-validated');
            document.getElementById('newCardSection').classList.add('active');
            document.getElementById('savedCardsSection').classList.remove('active');
            document.getElementById('newCardRadio').checked = true;
        }
        
        // Load pending payments
        async function loadPendingPayments() {
            try {
                const response = await fetch(`/api/payments/guest/${guestInfo.id}?status=PENDING`);
                if (response.ok) {
                    const pendingPayments = await response.json();
                    // Prefill the form with first pending payment if available
                    if (Array.isArray(pendingPayments) && pendingPayments.length > 0) {
                        const p = pendingPayments[0];
                        const bookingIdInput = document.getElementById('bookingId');
                        const amountInput = document.getElementById('amount');
                        if (bookingIdInput && p.bookingId) bookingIdInput.value = p.bookingId;
                        if (amountInput && p.amount) amountInput.value = p.amount;
                    }
                }
            } catch (error) {
                console.error('Error loading pending payments:', error);
            }
        }
        
        // Update payment summary
        function updateSummary(payments) {
            // Normalize
            const list = Array.isArray(payments) ? payments : [];
            const byBooking = new Map();
            list.forEach(p => {
                const bid = p.bookingId || '__none__';
                if (!byBooking.has(bid)) byBooking.set(bid, []);
                byBooking.get(bid).push(p);
            });
            let totalPaid = 0;
            let pendingAmount = 0;
            list.forEach(p => {
                const amt = parseFloat(p.amount) || 0;
                if (String(p.status).toUpperCase() === 'PAID') totalPaid += amt;
            });
            byBooking.forEach(arr => {
                const hasPaid = arr.some(x => String(x.status).toUpperCase() === 'PAID');
                if (!hasPaid) {
                    arr.forEach(x => {
                        if (String(x.status).toUpperCase() === 'PENDING') {
                            pendingAmount += (parseFloat(x.amount) || 0);
                        }
                    });
                }
            });
            document.getElementById('totalPaid').textContent = `$${totalPaid.toFixed(2)}`;
            document.getElementById('pendingAmount').textContent = `$${pendingAmount.toFixed(2)}`;
            document.getElementById('paymentCount').textContent = list.length;
        }
        
        // Update pending amount
        function updatePendingAmount(pendingPayments) {
            const pendingAmount = pendingPayments.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
            document.getElementById('pendingAmount').textContent = `$${pendingAmount.toFixed(2)}`;
        }
        
        // Get status badge color
        function getStatusColor(status) {
            switch (status.toUpperCase()) {
                case 'PAID':
                    return 'bg-success';
                case 'PENDING':
                    return 'bg-warning';
                case 'FAILED':
                case 'DECLINED':
                    return 'bg-danger';
                case 'REFUNDED':
                    return 'bg-info';
                default:
                    return 'bg-secondary';
            }
        }
        
        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString(undefined, options);
        }
        
        // Get card type from number
        function getCardType(number) {
            const visa = /^4[0-9]{12}(?:[0-9]{3})?$/;
            const mastercard = /^5[1-5][0-9]{14}$/;
            const amex = /^3[47][0-9]{13}$/;
            const discover = /^6(?:011|5[0-9]{2})[0-9]{12}$/;
            
            if (visa.test(number)) return 'Visa';
            if (mastercard.test(number)) return 'Mastercard';
            if (amex.test(number)) return 'Amex';
            if (discover.test(number)) return 'Discover';
            
            return 'Card';
        }
        // Map a card type string to a Font Awesome icon class
        function getCardIconClass(type) {
            const t = String(type || '').toLowerCase();
            if (t.includes('visa')) return 'fa-brands fa-cc-visa';
            if (t.includes('master')) return 'fa-brands fa-cc-mastercard';
            if (t.includes('amex')) return 'fa-brands fa-cc-amex';
            if (t.includes('discover')) return 'fa-brands fa-cc-discover';
            return 'fa-solid fa-credit-card';
        }
        
        // Download receipt
        function downloadReceipt(paymentId) {
            // In a real app, this would generate and download a PDF receipt
            // For now, we'll just show a success message
            showSuccess('Receipt download started');
            
            // Simulate receipt download
            setTimeout(() => {
                const link = document.createElement('a');
                link.href = `data:text/plain;charset=utf-8,${encodeURIComponent(`Receipt for Payment #${paymentId}`)}`;
                link.download = `receipt-${paymentId}.txt`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }, 1000);
        }
        
        // Show success toast
        function showSuccess(message) {
            const toastEl = document.getElementById('successToast');
            const toast = new bootstrap.Toast(toastEl);
            document.getElementById('successMessage').textContent = message;
            toast.show();
        }
        
        // Show error toast
        function showError(message) {
            const toastEl = document.getElementById('errorToast');
            const toast = new bootstrap.Toast(toastEl);
            document.getElementById('errorMessage').textContent = message;
            toast.show();
        }
    </script>
</body>
</html>